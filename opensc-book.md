---
#title: マイナンバーカードと電子署名の本
title: OpenSCと電子署名の本
author: \@hamano
date: 技術書典5
cover: static/cover.png
version: 0.1
---

\frontmatter
\let\thesectionorig\thesection
\renewcommand{\thesection}{}

# はじめに

マイナンバーカードというとどんな印象があるでしょうか?

「使いみちが無い」
「なんとなく怖い」

一般的にその様な印象を持っている方が多いようです。
マイナンバー（個人番号）に関して様々な議論がありますが、この本はマイナンバー制度とは直接関係ありませんし触れないようにしています。

これは自分のマイナンバーカードに搭載されているICチップにアクセスして遊ぼう、という趣旨の本です。
具体的にはOpenSCというオープンソース・ソフトウェアを使いながら公的個人認証の仕組みとその将来性について解説します。

公的個人認証は現在私達が行っているオンライン生活をより安全・便利にする可能性を持っています。
しかし公的個人認証が広く活用されるにはまだ多くの課題がある状況です。

まず国民全体に対する認知度が足りていません。
とりわけ、この本の対象読者であるような技術者にさえよく知られていないシステムが、安心して利用できる社会基盤として世の中に普及するのは難しいでしょう。

2章ではOpenSCというソフトウェアを使いながらマイナンバーカードにアクセスする方法を紹介します。
OpenSCはクロスプラットホームなソフトウェアですのでWindows、macOS、Linuxなど様々な環境で試すことができます。

マイナンバーカードのブラックボックスを明らかにし、「なんとなく怖い」という懸念点を払拭できれば幸いです。

\tableofcontents

\mainmatter
\let\thesection\thesectionorig

# マイナンバーカード

マイナンバーカードはいくつかの役割を持っています。

裏面にはマイナンバー(個人番号)が記載されていて、税金や年金、社会保障のために利用されます。
また、表面には氏名・住所・顔写真が記載されているので、これまで運転免許証で行っていたような本人確認にも利用できるでしょう。
これらはカードという物理的な特徴を用いた機能ですが、カードに含まれているICチップは更にいくつかの機能を持っています。

![マイナンバーカードのICチップ](static/structure.eps){width=50%}

マイナンバーカードのICチップの中はこんな風になっているよ、と総務省は説明しています。
上から、公的個人認証AP、券面事項補助入力AP、券面事項確認AP、住基AP、と4つの機能が入っていて、空き領域には新しい機能を追加できます。

しかし私たち技術者はこの様なふんわりした説明では満足できません。
カードにどの様なデータが格納されていて、どの様にアクセスするのかを知りたいはずです。

## ICチップの中身

マイナンバーカードのICチップは接触型・非接触型の2種類のインターフェースを持っています。
接触型であればISO/IEC 7816に対応したカードリーダー、非接触の場合NFC TypeBに対応したカードリーダーでアクセスできます。

マイナンバーカードには4つのAPが入っていると説明しました。APとはアプリケーション・プログラムの略です。
これはSDカードの様なただのストレージではありません。カード内で独立して駆動するプロセッサーがカードOSの上でアプリケーションを実行します。

各APはカードOS上で独立しており、お互いに干渉できません。
ICチップに格納されている秘密鍵を読み出すことは出来ないようになっており、ICチップの中で安全に暗号処理を行います。

## データモデル

![マイナンバーカードのデータモデル](static/datamodel.pdf){width=100%}

これは筆者が調査したマイナンバーカードのデータモデルです。

カードのデータモデルは私達が普段利用するファイルシステムのようにディレクトリ構造になっています。
また、ファイルシステムと同様にファイルに対してopenやreadといった操作を行います。具体的にはAPDUというISO/IEC 7816-4で定義されているバイナリプロトコルでやり取りします。

公的個人認証APには、証明書、CA証明書、秘密鍵が2セットあります。
これは前述したユーザー認証用とデジタル署名用の2つに対応します。

## 公的個人認証とは

公的個人認証はPKIをベースとした本人確認サービスです。

従来の住基カードにもこの公的個人認証の機能がありましたが用途が行政手続きのみに限られていました。
2017年からは用途が拡大され、民間のサービスでも利用できるようになっています。

また、マイナンバーカードにはデジタル署名用の証明書だけでなくユーザー認証用の証明書が追加されています。

## デジタル署名

マイナンバーカードにはRSA 2048bit鍵とそれに対応するX.509証明書が入っています。
これらを用いてデジタル署名およびユーザー認証処理を行うことが出来ます。

公的個人認証が提供するデジタル署名用証明書は、住民票に登録されている氏名・住所・年齢・性別(以下4属性)を証明します。
具体的にはX.509 Subject Alternative Namesにこれらの4属性が含まれています。

つまり、これまで住民票のコピーを提出しろと言われるような紙の手続きをオンラインでデジタル署名によって代替することができます。

このデジタル署名は印鑑による捺印を代替することもできます。
マイナンバーカードの中にはあなたの印鑑が入っていると言えます。

このデジタル署名は従来公的な電子申請で利用されていましたが、2017年より民間利用も可能となりました。

銀行口座などの金融口座の開設で利用される事が想定されています。

## ユーザー認証

マイナンバーカードにはユーザー認証用の証明書と秘密鍵も格納されています。

これは従来のユーザー名+パスワードによる認証を代替するものです。
現時点ではマイナポータルでの認証で利用でき、
将来的に銀行のオンラインバンキングなど民間システムでの利用も想定されています。

従来のシステムで長らく使われてきたユーザー名+パスワードによる認証方式は多くの問題と誤解を抱えています。
利用者側には長いパスワードを覚えられない・覚えたくないという問題があり、
サービス提供者側の問題としてはパスワード文字種の組み合わせを強制したりパスワードの定期変更を強制するという誤った認識が蔓延しています。

普段から公開鍵認証方式を用いてサーバーにSSHログインしている技術者には説明不要と思いますが、ほとんどの場合パスワード認証より公開鍵認証の方が安全です。[^password]

[^password]: パスワード認証と非対称鍵認証について、それぞれに長所と短所があり直接比較できるものでは無いが、マイナンバーカードを用いる場合、秘密鍵の利用にローカル認証(PIN)を求めている事と、物理的に秘密鍵を複製できない事により、NIST SP 800で定義される記憶+所有(ハードウェア) AAL3を満たす。したがってパスワード単独による認証(AAL1)より安全な認証方式と言える。



## デジタル署名とユーザー認証

公的個人認証では2種類の証明書を利用します。
デジタル署名とユーザー認証について、実際に行われている処理の内容に大きな違いはありません。
しかしデジタル署名とユーザー認証は異なる行為として区別する必要があります。
なぜこれら2つを使い分ける必要があるのでしょうか。

X.509証明書には証明書の用途(Key Usage)という項目があります。
デジタル署名用証明書には


ユーザー認証を行う場合、署名対象はNONCEなどの乱数であって同意したい文書では無いという違いがあります。

もし仮に、これらの区別を行わずユーザー認証目的にデジタル署名用証明書を利用した場合どうなるでしょうか。
悪意のあるRelying PartyがNONCEの代わりに契約文書を送ってきて、ユーザーの意図しない電子契約を行うかもしれません。

## 印鑑と電子署名

印鑑は古代メソポタミア文明の頃に発明されたとされています。
当時は円柱状の印鑑を粘土板の上で転がしながら押し付けるという方法で捺印が行われました。
現代において、この印鑑を押す習慣が残った数少ない国のひとつが日本です。
私たちはなぜ印鑑を押すのでしょうか。
銀行口座を作るとき、家を借りるとき、重要な契約を取り交わすシーンで印鑑が必要になります。

日本には印鑑登録という制度があるものの、印鑑を押したことにより法律的な効力を持つわけではありません。
あくまで裁判となった場合に本人が文書に同意したと推定する材料として利用されます。

今更この本の読者にデジタル署名と印鑑のどちらが安全かという説明は必要ないでしょう。
3Dプリンタが発達した昨今、そこらへんの子供でも印鑑の偽装が可能です。
もはや印影は只の装飾であり押印はスピリチュアルな儀式でしかありません。
私たちはいつまでこの形骸化したレガシーを引きずるのか、という課題を突きつけられています。

電子署名の普及が進まなければ、私たちの社会はある種の痛みを伴うでしょう。
印鑑偽装による詐欺事件や、官僚による公文書の偽造も私たち国民が受けた痛みのひとつです。

# OpenSCであそぼう

マイナンバーカードとOpenSCで遊ぶにあたり、注意して頂きたいことは法令の遵守です。
マイナンバーカードに関する法令はいろいろありますが特に厳しいのはマイナンバー(個人番号)に関する法令です。
マイナンバー(個人番号)を目的外(社会保障・税務・災害対策)に利用することは厳しく制限されています。

また、他人の公的個人認証の証明書を収集・記録することも制限されています。これを行うには総務大臣の認可が必要になります。

要点をまとめると、*他人のマイナンバーカードからデータを読み出して記録しない*ようにしましょう。
これだけ注意すれば、うっかり法律に違反してしまうことは無いでしょう。

自分のマイナンバーカードのデータを読み出したり、アクセスを禁止する法律はありません。
もしそんな法律があれば誰もマイナンバーカードを利用できなくなってしまいます。

公的個人認証が普及する為には
必要以上に怖がらず正しく遊びましょう。

## OpenSCとは

OpenSCはクロスプラットフォームで動作するスマートカード用のツール・ライブラリ群です。
カードドライバはカード固有の独自仕様を吸収し、標準仕様に適合させる役目を持ったミドルウェアです。

これは公的個人認証向けのPKCS#11 APIを実装し、PKCS#15エミュレーションできるようになったことを意味します。

OpenSCはWindows, macOS, Linuxなど多くの動作環境をサポートしています。

## OpenSCのインストール

OpenSCが公的個人認証に対応したのはバージョン0.17.0以降です。
古いOSの標準パッケージを利用すると公的個人認証を利用できない場合があるので注意してください。(例: Debian Stretchなど)

Debian Buster, Ubuntu 18.04 LTS では以下のようにして公的個人認証に対応したOpenSCをインストールできます。

~~~ {.bash}
$ sudo apt install -y opensc
~~~

Windows, macOSの人は以下のページから最新リリース版をダウンロードしてインストールしてください。

<https://github.com/OpenSC/OpenSC/wiki>

\clearpage

## 基本的な使い方

ここではマイナンバーカードを使ってOpenSCの基本的な使い方を説明します。

まずカード内のすべてのPKCS#15オブジェクトをダンプします。
PINオブジェクト、秘密鍵オブジェクト、公開鍵オブジェクト、証明書オブジェクトをそれぞれ2セット確認できます。

~~~ {.bash}
$ pkcs15-tool -D
~~~

ユーザー認証用証明書を表示します。
ユーザー認証用証明書は証明書番号1に対応付けされています。証明書はBase64エンコードしたPEM形式で出力しますのでopensslコマンドでテキスト形式に変換して表示します。


~~~ {.bash}
$ pkcs15-tool -r 1 | openssl x509 -text -noout
~~~

続いて、デジタル署名用証明書を表示します。
これは証明書番号2に対応付けされていますが、このままでは出力できません。
デジタル署名用証明書はパスワードで保護されているので、参照するだけでもパスワードを入力する必要があります。
`-a`オプションでPINオブジェクト2を指定し、公的個人認証のデジタル署名用パスワードを入力します。
(パスワードのアルファベットは大文字で入力してください。)

~~~ {.bash}
$ pkcs15-tool -r 2 -a 2 --verify-pin | openssl x509 -text -noout
~~~

最後にCA証明書の出力です。

~~~ {.bash}
# ユーザー認証用CA証明書を出力
$ pkcs15-tool -r 3

# デジタル署名用CA証明書を出力
$ pkcs15-tool -r 4
~~~

\clearpage

## マイナンバーカードでPDF署名

JSignPdf[^jsignpdf]はPDF署名を行うソフトウェアです。
このツールはPKCS#11ライブラリをサポートしていますので、OpenSCのPKCS#11ライブラリを利用することで公的個人認証の証明書で署名を行うことができます。

[^jsignpdf]: http://jsignpdf.sourceforge.net/

さっそくやってみましょう。環境は Ubuntu 18.04 LTS を想定していますが、JSignPdfはJavaアプリケーションですので他のOSでも一部読み替えていただければ動作するはずです。

OpenSC、Java Runtimeのインストール

~~~ {.bash}
$ sudo apt install -y opensc openjdk-8-jre
~~~

続いて設定ファイルを2つ編集します。

conf/conf.properties を以下のように編集(コメントを外すだけです):

~~~
pkcs11config.path=conf/pkcs11.cfg
~~~

OpenSCのPKCS11ライブラリをロードするようにします。

conf/pkcs11.cfg を以下のように編集:

~~~
name=OpenSC-PKCS11
library=/usr/lib/x86_64-linux-gnu/pkcs11/opensc-pkcs11.so
slot=1
~~~

ここで`slot=1`を指定しているのは公的個人認証のデジタル署名用証明書で署名するためです。

JSignPDFを実行します。

~~~ {.bash}
$ java -jar JSignPdf.jar
~~~

JSIgnPDFのGUIではキーストアタイプに「PKCS11」を選択し、キーストアパスワードに公的個人認証の電子署名用パスワードを入力します。
パスワードのアルファベットは大文字で入力してください。
入力PDFファイルと出力PDFファイルを指定して「Sign It」ボタンを押すと署名できます。

署名できたものの、正しく署名できたのか不安になることでしょう。
JSignPDFには簡易的な検証を行うツール(Verifier.jar)も付属しておりこれを使って署名済みPDFを検証できます。

~~~ {.bash}
# JPKIデジタル署名用CA証明書を読み出し
$ pkcs15-tool --read-certificate 4 > ca.pem
$ java -jar Verifier.jar signed.pdf -c ca.pem
~~~

出力結果に`fails=no`という行があればCA証明書による署名検証は成功しています。
ただこちらのツールはデバッグツールのようで通常これを使うことはないでしょう。

Adobe Acrobat Reader DCで署名検証すると以下の様に表示されます。[^acrobatreader]

![Adobe Acrobat Reader DCの署名パネル](static/acrobatreader.png){width=100%}


[^acrobatreader]: 「環境設定」->「検証」->「Windows統合」->「署名を検証」にチェックをいれると、Windowsの証明書ストアを参照するようになった。

もちろんこれは失効情報などを確認しない簡易的な署名検証です。
PDFに署名された証明書からCA署名書までの信頼のパスを構築できたことを意味します。


\clearpage

## マイナンバーカードでSSHする

公的個人認証APにはユーザー認証用の証明書と秘密鍵が入っていることを説明しました。
この秘密鍵はRSA 2048bit鍵ですのでSSH認証にも利用できそうです。

ネットワーク機器に携わるエンジニアであれば日常的にSSHを利用されていると思いますので詳しい説明は省きますが、SSHプロトコルについて簡単に説明しておきます。

クライアントとサーバーはまずバージョン情報を交換し、DH鍵交換、ホスト認証を行います。
これにより暗号化されたトランスポート層を確立します。

![SSHプロトコル](static/ssh-protocol.eps){width=100%}

続いて認証方式のネゴシエーションを行い、公開鍵方式、あるいはパスワード認証を行うかどうかを決めます。

\clearpage

SSHの公開鍵認証方式では図にようなデータに対して署名を行います。
今回は公的個人認証の認証用秘密鍵で署名を行いSSH認証をやってみます。

![SSH公開鍵認証方式](static/ssh-auth.eps){width=100%}

まずは認証用公開鍵をOpenSSH形式で取り出して、authorized_keysに登録しましょう。
認証用公開鍵は番号1に対応します。

~~~
$ pkcs15-tool --read-ssh-key 1 > id_rsa.pub
~~~

この公開鍵をサーバー側のauthorized_keysに登録したら、いよいよSSHログインです。

OpenSSHはPKCS#11 APIに対応していますので-IオプションでさきほどビルドしたPKCS11ライブラリを指定します。 (~/.ssh/configにPKCS11Provideを指定できるので通常この長いオプションは不要です。)

~~~
$ ssh -I /usr/lib/x86_64-linux-gnu/opensc-pkcs11.so hostname
Enter PIN for 'JPKI (User Authentication PIN)':
~~~

このようにPIN入力を求められるので役所で設定した4桁数字の暗証番号を入力します。 
これで図に示したデータに対して署名を行い、認証成功となります。

今回はSSH認証なので証明書は使いませんでしたが、証明書の失効情報を得るにはなぜか総務大臣の認可が必要だそうなので証明書の検証が必要な場合は面倒ですが申請するしかないですね。

## マイナンバーカードでPAM認証

## マイナンバーカードでmacOSにログイン




\backmatter
\renewcommand{\thesection}{}

# あとがき

## e-taxについて

みなさんはe-taxで確定申告を行ったことはあるでしょうか?

あのシステムはとても良くできていて、フォームを埋めていくと簡単にPDFの申告書を作成できます。
ただ、筆者は最後のe-taxで申告書を送信するところまでを含めた電子申告をやった事はありません。
筆者は普段LinuxのデスクトップPCを利用しており、申告書の署名・送信にはWindows用の専用アプリケーションが必要だからです。

出来ることならエストニアのようにLinuxPCもサポートして欲しいところですが、日本の行政システムにそこまでを望んでいるわけではありません。
この様な公共システムには多大な税金が使われているのでニッチな人々の要望を満たす前にもっとやるべきことはあるでしょう。たとえばAndroidやiOSのサポートです。

対応プラットフォームの拡大は民間のシステムにおいても悩ましい問題です。
しかしe-taxが署名済みPDFファイルを国税庁のWEBサイトにアップロードするインターフェースだったらどうでしょう。
PDF仕様はオープンで、種々様々なプラットフォームでPDF署名は可能です。

サードパーティが作成したツールがうまく動かなかった時どうするんだという、サポートについての責任論は発生しそうですが、少なくともLinuxユーザーは自己責任において電子申告できそうです。

## 参考文献

